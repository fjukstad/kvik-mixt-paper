In this section we first motivate our microservice approach based on our
experiences developing the MIxT web application.
We describe the process from initial data analysis to the final application,
highlighting the importance
% LAB + performance/scalability/deployment (dvs noe som er kvantifiserbart)
of language-agnostic services to facilitate the use of different tools in
different parts of the application. 
We then generalize the ideas to a set
of principles and services that can be reused and shared between applications. 
% LAB: + Design and impl of micro-services.

\subsection*{Matched Interactions Across Tissues (MIxT)} 
The aim of the MIxt study was to identify genes and pathways in the primary
breast tumor that are tightly linked to genes and pathways in the patient blood
cells. We generated and analyzed expression profiles from blood and matched
tumor cells in 173 breast cancer patients included in the Norwegian Women and
Cancer (NOWAC) study.\cite{vanessa}
The MIxT analysis starts by identifying sets of genes tightly co-expressed
across all patients in each tissue. Each group of genes or modules were
annotated based on known a priori biological knowledge about gene functionality.
Focus was placed on the relationships between tissues by asking if specific
biologies in one tissue are linked with (possibly distinct) biologies in the
second tissue, and this within different subgroup of patients (i.e. subtypes of
breast cancer).

An R package\footnote{\url{github.com/vdumeaux/mixt}} was built to contain the
statistical methods and static visualizations for identifying associations
between modules across tissues. The exploration of the results encompass the
examination  of $\sim20$ modules and their functional enrichments.  That is
$\sim23\times19=437$ associations computed for each of the $22$ patient
subgroups. 
An application integrating many types of information was therefore needed to
explore this large amount of data and results.
The system needed to directly interface with the R package should be accessible
through standard protocols, such as HTTP, not enforcing any programming language
or platform on the application developer. 

A large part of biological data research is to link the results to known biology
from literature or reference databases. In the MIxT project we needed an
application that could interface with a set of different databases, keeping the
information up-to-date. We interface with MSigDB to get gene set meta-data and
the Entrez Programming Utilities (E-utils) to get gene meta-data. 
As with the R interface the interface to the databases
should be accessible from any programming language. 

A key feature that motivated the design of MIxT was that we want to
have the flexibility to run the application on any platform. Bundling each
component in a software container such as Docker allows us to deploy the
application on a wide range of hardware, from local installations to deployments
to cloud providers such as Amazon Web Services\footnote{\url{aws.amazon.com}}.

% LAB: Performance krav?

% LAB: Provenacne / reproducibility krav?

\subsection*{Kvik}
Our experience in developing MIxT can be generalized into the following design
principles and microservices encapsulated in the Kvik framework. 

\textbf{Principle 1}: Build applications as collections of language-agnostic
microservices. This makes it possible to re-use key components and build
specialized data exploration applications in the most suitable programming
language. 

\textbf{Principle 2}: Deploy each service using container technology such as
Docker. This has a number of benefits. It simplifies deployment itself, it makes
it trivial to share services between projects and research groups, and it
ensures reproducible services.

\textbf{Principle 3}: Package statistical methods and data as software packages
that can be used by power-users and the data exploration tools themselves. An
example is to build an application using R packages and OpenCPU or Kvik. This
makes it possible to either explore the data and methods through the data
exploration application or an R session. 

From these three main principles we built a set of software packages to build
microservices used in data exploration application in systems biology. We built
a compute service for executing statistical analyses and a database service for
retrieving relevant information on genes and biological processes.  Using these
it is possible to develop specialized data exploration application in any modern
programming language.  

% Også er det viktig å ikke glemme "system aspects" performance, management,
% deployment, etc for disse. Det kn enten forklares her eller senere.
% Det er ikke forklart hvordan ting henger sammen i Kvik, så dette er vanskelig
% å forstå
% LAB: her er stedet for alle Go bibliotek og andre lavnivå detlajer

\subsubsection*{Building applications} 
Kvik provides an interface to perform database lookup and execute statistical
analyses. Application developers focus on implementing the
application-specific user interfaces and statistical analyses, using the
microservices from Kvik to execute the analyses and get meta-data for the
results. 

Figure \ref{kvik-mixt} illustrates the
relationship between the MIxT application and Kvik. In MIxT we built a
specialized web application that interfaces with Kvik to get data from
biological databases and to run statistical analyses from the mixtR R package. 

\begin{figure}[h!]
\centering
\includegraphics{figures/kvik-mixt.png}
\caption{An overview of the relationship between the MIxT application and Kvik.
MIxT contains a web application (online at \url{mixt-blood-tumor.bci.mcgill.ca})
and the R Package that provides analyses and data to the web application. Kvik
provides the services for running the statistical analyses from the R package,
and the database lookups found in the web application.} 
\label{kvik-mixt}
\end{figure} 

It is important to note that since the end applications interface directly with
R, developers can leverage this to produce dynamic visualizations. For example,
if an application uses a clustering method to color nodes in a graph, end-users
can tweak parameters that interactively change the node coloring in graph
visualization.
% LAB: mangler beskrivelse av reference databases

In Kvik we do not specify what programming language or set of tools to use to
build an application. We believe that by building an application as a set of
services that communicate over standard protocols, application developers can
choose the most suitable language, or framework, to build specialized
visualizations and user interfaces. 

\subsubsection*{Compute Service}
% LAB: Ikke motivert hvorfor det er en interface til R
% LAB: Ikke forklart hvordan en appliakasjons programmerer skal tenke på denne servicen. Dvs hva den brukes til og hva den tilbyr. Første paragraf hopper rett inn i interfacen.
% Hva er fordelene med å gjøre det i go?
The compute service in Kvik is built using a hybrid state pattern\cite{opencpu}.
We provide three main operations for interfacing with R:
Call, Get, and RPC. The Call operation is used to execute and run a function
from an R package. It takes as input an R package name, a function name, and
optional arguments. It returns a unique identifier that later can be used by the
Get operation to retrieve results. The Get operation is used to get results in
different output formats, e.g. JSON, CSV, PDF, or PNG. The RPC is just a
combination of a Call and a subsequent Get. 

% LAB: Ikke nødvendigvis klart for leseren hva som er fordelene med en slik
% microservice. Eller hvorfor det blir enklere å utivkle apps vha denne.

% LAB: performance, scalability, & provenance?

\subsubsection*{Database Service} 
The database service provides an interface to biological databases for
retrieving meta-data on genes and processes. 
% LAB: provencance, performance, scalability
% LAB: Dette kan tas på slutten
In Kvik we have built packages for
interfacing with
E-utilities\footnote{\url{eutils.ncbi.nlm.nih.gov}},
MSigDB\footnote{\url{software.broadinstitute.org/gsea/msigdb}}, Hugo Gene
Nomenclature Committe (HGNC)\footnote{\url{genenames.org}}, and Kyoto Encyclopedia
of Genes and Genomes (KEGG)\footnote{\url{kegg.jp}}. 

TODO: Talk about licensing issues. 

% LAB: Dette er veldig overfladisk beskrevet. Hvordan bruker application
% programmerern den? Hvor lagres ting? Hva slags datastrukturer brukes? Hvor
% stor er cachen? Er den delt? Eviction policy? Antatt size på working set? Er
% den komprimert? etc
The database service uses a caching mechanism to reduce the load on the online
databases. It will also speed up subsequent queries for a cached object, since
the query can be served out of cache and not having to be fetched from a remote
database. We allow application developers to specify the cache eviction policy,
but on default the database service does not evict anything from its cache
before the service is restarted. This can be modified by the application
developer. 

% LAB: fordel av å bruke den; hvorfor det gjør livet enklere...

% LAB: savner en beskrivelse (del kapittel) av deployment og andre ting som har med management av disse services og apps

\subsection*{Implementation}
In ths section we describe the implementation details in Kvik and the
microservices required to build the MIxT web application. 

Kvik is implemented as a collection of Go packages required to build services
that can integrate statistical
software in a data exploration and provide an interface to up-to-date biological
databases. We chose the Go programming language because of its performance, ease
of development, and simple deployment. 
To integrate R we provide two packages \emph{gopencpu} and
\emph{r}, that interface with OpenCPU and Kvik R servers respectively. To
interface with biological databases we provide the packages \emph{eutils},
\emph{gsea}, \emph{genenames}, and \emph{kegg} that interface with E-utils,
MsigDB, HGNC and KEGG respectively.
In addition to these packages we provide Docker images that implement the
two required microservices. 

Both the compute and the databases service in Kvik builds on the standard
\emph{http} library in Go. On start the compute service 
launches a user-defined number of R sessions that execute analyses on demand.
This allows for parallel execution of analyses. We provide a simple FIFO queue
for queuing of requests. The compute service also provides the opportunity for users to
cache analysis results to speed up subsequent calls. The database service use
the \emph{gocache}\footnote{\url{github.com/fjukstad/gocache}} package to cache
any query to an online database.

% LAB: Litt usikker på om dette hører til i Results eller Methods
% \subsection*{Applications}
% Stress.
% Pathways.
% MIxT .
% Command line-man. 
% 
% % LAB: kort beskrivelse av hva alle apps gjør
% 
% % LAB: Figur som viser hva som er felles og ulikt for alle appene. Her bør noe
% % være likt ellers har vi bare 3-4 applikasjoner :)
% 
% % LAB: mer detaljert beskrivelse av hvordan hver app er implementert med Kvik
% 
% 
